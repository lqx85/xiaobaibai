<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>小白白高度表</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
  <header>
    <h1>小白白高度表</h1>
  </header>
  <div class="topnav">
    <a href="index.html">简要介绍</a>
    <a href="normal_setting.html">参数设置</a>
    <a href="advance_setting.html" class="active">高级设置</a>
    <a href="firmware_upgade.html">更新固件</a>
  </div>
  <div class="content">
    <div class="card-grid">
      <div class="card">
        <p>
          <button id="connectBleButton" class="connectButton"> 打开小白白的链接</button>
          <span style="padding-left: 50px;"></span>
          <button id="disconnectBleButton" class="disconnectButton"> 断开小白白的链接</button>
        </p>
        <p class="gray-label">链接状态: <strong><span id="bleState" style="color:#d13a30;">未链接</span></strong>
        </p>
      </div>
    </div>
    <div class="card-grid">
      <div class="card">
        <h2>上升提示音</h2>
        <form name="form_climb">
          <p class="p_left">
            最大速度<span style="padding-left: 20px;"></span><input type="number" id="climb_max" min="5.0" max="10.0"
              step="0.1">m/s
            <br>频率<span style="padding-left: 56px;"></span><input type="number" id="climb_hz_min" min="600" max="1000"
              step="10" placeholder="min">
            <input type="number" id="climb_hz_max" min="1000" max="2000" step="10" placeholder="max">Hz
            <br>高音时长<span style="padding-left: 20px;"></span><input type="number" id="climb_th_min" min="30" max="60"
              step="10" placeholder="min">
            <input type="number" id="climb_th_max" min="30" max="70" step="10" placeholder="max">ms
            <br>静音时长<span style="padding-left: 20px;"></span><input type="number" id="climb_tl_min" min="80" max="600"
              step="10" placeholder="min">
            <input type="number" id="climb_tl_max" min="80" max="600" step="10" placeholder="max">ms
            <br><span style="padding-left: 30px;"></span><button id="get_adv_climb" class="button_small">
              获取当前参数</button>
            <span style="padding-left: 20px;"></span><button id="set_adv_climb" class="button_small">提交修改</button>
          </p>
        </form>
      </div>

      <div class="card">
        <h2>下沉提示音</h2>
        <form name="form_sink">
          <p class="p_left">

            最大速度<span style="padding-left: 20px;"></span><input type="number" id="sink_max" min="-8.0" max="-4.0"
              step="1.0">m/s
            <br>频率<span style="padding-left: 56px;"></span><input type="number" id="sink_hz_min" min="50" max="150"
              step="10" placeholder="min">
            <input type="number" id="sink_hz_max" min="150" max="250" step="10" placeholder="max">Hz
            <br>高音时长<span style="padding-left: 20px;"></span><input type="number" id="sink_th_min" min="200" max="600"
              step="10" placeholder="min">
            <input type="number" id="sink_th_max" min="600" max="1000" step="10" placeholder="max">ms
            <br>静音时长<span style="padding-left: 20px;"></span><input type="number" id="sink_tl_min" min="600" max="900"
              step="10" placeholder="min">
            <input type="number" id="sink_tl_max" min="600" max="1000" step="10" placeholder="max">ms
            <br><span style="padding-left: 30px;"></span><button id="get_adv_sink" class="button_small"> 获取当前参数</button>
            <span style="padding-left: 20px;"></span><button id="set_adv_sink" class="button_small">提交修改</button>
          </p>
        </form>
      </div>
    </div>

    <div class="card-grid">
      <div class="card">
        <h2>气流边沿提示音</h2>
        <form name="form_near">
          <p class="p_left">

            频率<span style="padding-left: 56px;"></span><input type="number" id="near_hz" min="300" max="800"
              step="10">Hz
            <br>高音时长<span style="padding-left: 20px;"></span><input type="number" id="near_th" min="20" max="100"
              step="10">ms
            <br>静音时长<span style="padding-left: 20px;"></span><input type="number" id="near_tl" min="1000" max="5000"
              step="10">ms
            <br><span style="padding-left: 30px;"></span><button id="get_adv_near" class="button_small"> 获取当前参数</button>
            <span style="padding-left: 20px;"></span><button id="set_adv_near" class="button_small">提交修改</button><br>
          </p>
        </form>
      </div>

      <div class="card">
        <h2>静态滑翔提示音</h2>
        <form name="form_glid">
          <p class="p_left">

            频率<span style="padding-left: 56px;"></span><input type="number" id="glid_hz" min="300" max="600"
              step="10">Hz
            <br>高音时长<span style="padding-left: 20px;"></span><input type="number" id="glid_th" min="20" max="100"
              step="10">ms
            <br>静音时长<span style="padding-left: 20px;"></span><input type="number" id="glid_tl" min="1000" max="6000"
              step="10">ms
            <br><span style="padding-left: 30px;"></span><button id="get_adv_glid" class="button_small"> 获取当前参数</button>
            <span style="padding-left: 20px;"></span><button id="set_adv_glid" class="button_small">提交修改</button>
          </p>
        </form>
      </div>
    </div>

    <div class="card-grid">
      <div class="card">
        <h2>电压计算参数设置</h2>
        <form name="form_battery">
          <p class="p_left">
            比例系数<span style="padding-left: 20px;"></span><input type="number" id="battery_factor" min="0.00" max="4.00"
              step="0.01">
            <br>测量误差<span style="padding-left: 20px;"></span><input type="number" id="battery_offset" min="-100"
              max="100" step="1">mV
            <br>线路压降<span style="padding-left: 20px;"></span><input type="number" id="battery_drop" min="0" max="500"
              step="1">mV
            <br><span style="padding-left: 30px;"></span><button id="get_battery" class="button_small"> 获取当前参数</button>
            <span style="padding-left: 20px;"></span><button id="set_battery" class="button_small">提交修改</button>
          </p>
        </form>
      </div>

      <div class="card">
        <h2>蓝牙协议</h2>
        <p class="p_left">
          选择协议<span style="padding-left: 20px;"></span><select name="protocol_type" id="protocol"
            style="padding-left: 20px;">
            <option value="0">LK8EX1</option>
            <option value="1">LXWP0</option>
            <option value="2">PTAS1</option>
            <option value="3">PRS</option>
          </select>
          <br><span style="padding-left: 30px;"></span><button id="get_proto" class="button_small"> 获取当前参数</button>
          <span style="padding-left: 20px;"></span><button id="set_proto" class="button_small">提交修改</button>
        </p>
      </div>
    </div>

    <div class="card-grid">
      <div class="card">
        <h2>屏幕显示</h2>
          <p class="p_left">
            显示电压<span style="padding-left: 20px;"></span><input type="number" id="show_voltage">
            <br>
            <span style="padding-left: 30px;"></span><button id="get_screen_setting" class="button_small"> 获取当前参数</button>
            <span style="padding-left: 20px;"></span><button id="set_screen_setting" class="button_small">提交修改</button>
          </p>

      </div>

      <div class="card">
        <div id="log" class="black-bg"></div>
        </p>
      </div>
    </div>
  </div>
  <script src="app.js"></script>
  <script>
    const button_set_adv_climb = document.getElementById('set_adv_climb');
    const button_set_adv_sink = document.getElementById('set_adv_sink');
    const button_set_adv_near = document.getElementById('set_adv_near');
    const button_set_adv_glid = document.getElementById('set_adv_glid');

    const button_set_battery = document.getElementById('set_battery');
    const button_set_proto = document.getElementById('set_proto');

    const button_get_adv_climb = document.getElementById('get_adv_climb');
    const button_get_adv_sink = document.getElementById('get_adv_sink');
    const button_get_adv_near = document.getElementById('get_adv_near');
    const button_get_adv_glid = document.getElementById('get_adv_glid');
    const button_get_proto = document.getElementById('get_proto');
    const button_get_battery = document.getElementById('get_battery');

    const button_get_screen_setting = document.getElementById('get_screen_setting');
    const button_set_screen_setting = document.getElementById('set_screen_setting');

    button_set_adv_climb.addEventListener('click', (event) => {
      event.preventDefault();
      if (input_validation("form_climb") == 0) {
        let command = 'set_adv_climb' +
          ' --mx='  + document.getElementById("climb_max").value + 
          " --hzl=" + document.getElementById("climb_hz_min").value + 
          " --hzr=" + document.getElementById("climb_hz_max").value + 
          " --tll=" + document.getElementById("climb_tl_min").value + 
          " --tlr=" + document.getElementById("climb_tl_max").value + 
          " --thl=" + document.getElementById("climb_th_min").value + 
          " --thr=" + document.getElementById("climb_th_max").value ;
        sendMessage(command);
      }
    });

    button_set_adv_sink.addEventListener('click', (event) => {
      event.preventDefault();
      if (input_validation("form_sink") == 0) {
        let command = 'set_adv_sink' +
          ' --mx='  + document.getElementById("sink_max").value + 
          " --hzl=" + document.getElementById("sink_hz_min").value + 
          " --hzr=" + document.getElementById("sink_hz_max").value + 
          " --thl=" + document.getElementById("sink_th_min").value + 
          " --thr=" + document.getElementById("sink_th_max").value + 
          " --tll=" + document.getElementById("sink_tl_min").value + 
          " --tlr=" + document.getElementById("sink_tl_max").value;
        sendMessage(command);
      }
    });

    button_set_adv_near.addEventListener('click', (event) => {
      event.preventDefault();
      if (input_validation("form_near") == 0) {
        let command = 'set_adv_near' + 
          ' --hz=' + document.getElementById("near_hz").value + 
          " --th=" + document.getElementById("near_th").value + 
          " --tl=" + document.getElementById("near_tl").value;
        sendMessage(command);
      }
    });

    button_set_adv_glid.addEventListener('click', (event) => {
      event.preventDefault();
      if (input_validation("form_glid") == 0) {
        let command = 'set_adv_glid' +
          ' --hz=' + document.getElementById("glid_hz").value + 
          " --th=" + document.getElementById("glid_th").value + 
          " --tl=" + document.getElementById("glid_tl").value;
        sendMessage(command);
      }
    });

    button_set_battery.addEventListener('click', (event) => {
      event.preventDefault();
      if (input_validation("form_battery") == 0) {
        let command = 'set_battery' +
          ' -f=' + document.getElementById("battery_factor").value + 
          " -o=" + document.getElementById("battery_offset").value + 
          " -d=" + document.getElementById("battery_drop").value;
        sendMessage(command);
      }
    });

    button_set_proto.addEventListener('click', (event) => {
      event.preventDefault();
      let command = 'set_proto -p=' + document.getElementById("protocol").selectedIndex;
      sendMessage(command);
    });

    button_get_screen_setting.addEventListener('click', (event) => {
      event.preventDefault();
      let command = 'get_screen_setting';
      sendMessage(command);
    });

    button_set_screen_setting.addEventListener('click', (event) => {
      event.preventDefault();
      let command = 'set_screen_setting --show=' + document.getElementById("show_voltage").value;;
      sendMessage(command);
    });


    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    button_get_adv_climb.addEventListener('click', async (event) => {
      event.preventDefault();
      sendMessage('get_adv_climb');
    });
    button_get_adv_sink.addEventListener('click', async (event) => {
      event.preventDefault();
      sendMessage('get_adv_sink');
    });
    button_get_adv_near.addEventListener('click', async (event) => {
      event.preventDefault();
      sendMessage('get_adv_near');
    });
    button_get_adv_glid.addEventListener('click', async (event) => {
      event.preventDefault();
      sendMessage('get_adv_glid');
    });
    button_get_proto.addEventListener('click', async (event) => {
      event.preventDefault();
      sendMessage('get_proto');
    });
    button_get_battery.addEventListener('click', async (event) => {
      event.preventDefault();
      sendMessage('get_battery');
    });

    function input_validation(form_name) {
      var elements = document.forms[form_name].getElementsByTagName("input");
      for (i = 0; i < elements.length; i++) {
        if (elements[i].value == "") {
          alert("数值不能为空！");
          return 1;
        }
        if (parseFloat(elements[i].value) > parseFloat(elements[i].max) ||
          parseFloat(elements[i].value) < parseFloat(elements[i].min)) {
          alert("超出取值范围！");
          return 2;
        }
      }
      return 0;
    }

    function OnReceiveData(data) {
      // 高度表数据
      if (rx_buffer.startsWith("$LK8EX1") ||
        rx_buffer.startsWith("$PTAS1") ||
        rx_buffer.startsWith("$PTAS1") ||
        rx_buffer.startsWith("$LXWP0")) {
        return;
      }

      const receivedata = data.replace('\n', '').split(";");
      for (let i = 0; i < receivedata.length; i++) {
        const pear = receivedata[i].split("=");
        var ele = document.getElementById(pear[0]);
        if (ele == null)
          continue;
        if (pear[0] == "protocol")
          ele.selectedIndex = pear[1];
        else if (ele.getAttribute("type") == "radio")
          ele.checked = (pear[1] == "1");
        else
          ele.value = pear[1];
      }
    }

  </script>

</body>

</html>